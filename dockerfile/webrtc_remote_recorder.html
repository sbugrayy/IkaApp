<!DOCTYPE html>

<html lang="tr">

<head>

<meta charset="UTF-8">

<title>WebRTC Remote Stream Kayıt</title>

<style>

    body { font-family: sans-serif; padding: 16px; }

    video { width: 320px; max-width: 100%; background: #000; border-radius: 8px; margin: 8px; }

    button { padding: 8px 12px; border-radius: 8px; border: 0; cursor: pointer; margin-top: 12px; }

    #videos { display: flex; gap: 16px; flex-wrap: Wrap; }

</style>

</head>

<body>



<h2>WebRTC Remote Stream Kayıt</h2>

<div id="videos">

    <video id="localVideo" autoplay playsinline muted></video>

    <video id="remoteVideo" autoplay playsinline></video>

</div>

<br>

<button id="startBtn">Bağlantıyı Başlat</button>

<button id="recordBtn" disabled>Kaydı Başlat/Durdur</button>

<p id="status">Durum: Bekleniyor...</p>



<script>

const localVideo = document.getElementById("localVideo");

const remoteVideo = document.getElementById("remoteVideo");

const statusEl = document.getElementById("status");

const startBtn = document.getElementById("startBtn");

const recordBtn = document.getElementById("recordBtn");



let pc = new RTCPeerConnection({

    iceServers: [

        { urls: "stun:stun.l.google.com:19302" },

        {

            urls: "turn:172.17.0.2:3478?transport=udp",

            username: "ffarmo",

            credential: "489624"

        },

        {

            urls: "turn:172.17.0.2:3478?transport=tcp",

            username: "ffarmo",

            credential: "489624"

        },

        {

            urls: "turns:172.17.0.2:5349",

            username: "ffarmo",

            credential: "489624"

        }

    ]

});



let mediaRecorder;

let chunks = [];



let isOfferer = false;

let remoteDescriptionSet = false;



async function sendData(data) {

    await fetch("http://104.28.244.150:3000/data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

}



setInterval(async () => {

    const response = await fetch("http://104.28.244.150:3000/data");

    const data = await response.json();



    if (!isOfferer && data.offer && !remoteDescriptionSet) {

        statusEl.textContent = "Teklif (Offer) alındı, cevap (Answer) oluşturuluyor...";

        await pc.setRemoteDescription(data.offer);

        remoteDescriptionSet = true;

        const answer = await pc.createAnswer();

        await pc.setLocalDescription(answer);

        await sendData(answer);

        statusEl.textContent = "Cevap (Answer) gönderildi.";

    }



    if (isOfferer && data.answer && !remoteDescriptionSet) {

        statusEl.textContent = "Cevap (Answer) alındı.";

        await pc.setRemoteDescription(data.answer);

        remoteDescriptionSet = true;

    }



    if(data.candidates && remoteDescriptionSet){

        for(const candidate of data.candidates){

             try {

                await pc.addIceCandidate(candidate);

             } catch(e) {



             }

        }

    }



}, 2000);



startBtn.onclick = async () => {

    isOfferer = true;

    statusEl.textContent = "Teklif (Offer) oluşturuluyor...";

    const offer = await pc.createOffer();

    await pc.setLocalDescription(offer);

    await sendData(offer);

    statusEl.textContent = "Teklif (Offer) gönderildi, cevap bekleniyor...";

    startBtn.disabled = true;

};



pc.onicecandidate = event => {

    if (event.candidate) {

        sendData(event.candidate);

    }

};



pc.ontrack = event => {

    remoteVideo.srcObject = event.streams[0];

    statusEl.textContent = "Uzak bağlantıdan görüntü geldi!";

    recordBtn.disabled = false;

};



navigatör.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {

    localVideo.srcObject = stream;

    stream.getTracks().forEach(track => pc.addTrack(track, stream));

});



recordBtn.onclick = () => {

    if (!remoteVideo.srcObject) {

        alert("Remote stream yok, kayıt başlatılamaz!");

        return;

    }

    if (!mediaRecorder || mediaRecorder.state === "inactive") {

        chunks = [];

        mediaRecorder = new MediaRecorder(remoteVideo.srcObject);

        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

        mediaRecorder.onstop = () => {

            const blob = new Blob(chunks, { type: "video/webm" });

            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");

            a.href = url;

            a.download = "remote_stream.webm";

            a.click();

            setTimeout(() => URL.revokeObjectURL(url), 10000);

            statusEl.textContent = "Kayıt tamamlandı.";

        };

        mediaRecorder.start(1000);

        statusEl.textContent = "Kayıt başladı...";

        recordBtn.textContent = "Kaydı Durdur";

    } else {

        mediaRecorder.stop();

        recordBtn.textContent = "Kaydı Başlat/Durdur";

    }

};

</script>



</body>

</html>