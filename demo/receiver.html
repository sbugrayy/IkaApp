<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Receiver</title>
<style>
    body { font-family: sans-serif; }
    .video-container { display: none; gap: 20px; }
    video { width: 48%; max-width: 100%; border: 1px solid #ccc; }
    h3 { margin-bottom: 5px; }
</style>
</head>
<body>
<h2>Alıcı WebRTC</h2>
<div id="room-selection">
    <input type="text" id="room-input" placeholder="Oda Adı Girin">
    <button id="join-btn">Odaya Katıl</button>
</div>

<div id="video-container-div" class="video-container">
    <div>
        <h3>Uzak Görüntü (Sender)</h3>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div>
        <h3>Yerel Görüntü (Siz)</h3>
        <video id="localVideo" autoplay playsinline muted></video>
    </div>
</div>
<br>
<p><b>ICE Durumu:</b> <span id="ice-status"></span></p>
<button id="recordBtn" disabled>Uzak Görüntüyü Kaydet</button>
<p id="status"></p>

<script>
const iceStatusEl = document.getElementById('ice-status');
const remoteVideo = document.getElementById("remoteVideo");
const localVideo = document.getElementById("localVideo");
const btn = document.getElementById("recordBtn");
const statusEl = document.getElementById("status");
const roomInput = document.getElementById('room-input');
const joinBtn = document.getElementById('join-btn');
const roomSelectionDiv = document.getElementById('room-selection');
const videoContainerDiv = document.getElementById('video-container-div');

let pc;
let ws;
let mediaRecorder, chunks=[];
// HERKESE AÇIK GÜVENİLİR SİNYAL SUNUCUSU
const SIGNALING_SERVER_URL = "wss://simple-webrtc-p2p-signaling.glitch.me";

const iceServers = {
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
    ],
};

joinBtn.onclick = () => {
    const roomName = roomInput.value;
    if (!roomName) {
        alert("Lütfen bir oda adı girin.");
        return;
    }

    ws = new WebSocket(SIGNALING_SERVER_URL);

    ws.onopen = () => {
        console.log("RECEIVER: WebSocket bağlantısı açıldı.");
        ws.send(JSON.stringify({ type: 'join', room: roomName }));
        roomSelectionDiv.style.display = 'none';
        videoContainerDiv.style.display = 'flex';
        init();
    };

    ws.onclose = () => console.error("RECEIVER: WebSocket bağlantısı kapandı!");
    ws.onerror = (err) => console.error("RECEIVER: WebSocket hatası:", err);

    ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        if (data.room === roomName) {
            if(data.sdp){
                await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                if(data.sdp.type==="offer"){
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    sendToServer({sdp:pc.localDescription});
                }
            }
            if(data.candidate){
                await pc.addIceCandidate(data.candidate);
            }
        }
    };
};

function sendToServer(msg) {
    msg.room = roomInput.value;
    ws.send(JSON.stringify(msg));
}

async function init() {
    pc = new RTCPeerConnection(iceServers);
    pc.oniceconnectionstatechange = () => {
        iceStatusEl.textContent = pc.iceConnectionState;
    };

    pc.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
        statusEl.textContent="Remote stream geldi.";
        btn.disabled = false;
    };

    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = stream;
}
</script>
</body>
</html>