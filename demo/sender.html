<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Sender</title>
</head>
<body>
<h2>Gönderici WebRTC</h2>
<div id="room-selection">
    <input type="text" id="room-input" placeholder="Oda Adı Girin">
    <button id="join-btn">Odaya Katıl</button>
</div>
<video id="localVideo" autoplay muted playsinline style="display:none;"></video>
<p><b>ICE Durumu:</b> <span id="ice-status"></span></p>

<script>
const iceStatusEl = document.getElementById('ice-status');
const videoEl = document.getElementById("localVideo");
const roomInput = document.getElementById('room-input');
const joinBtn = document.getElementById('join-btn');
const roomSelectionDiv = document.getElementById('room-selection');

let pc;
let ws;

const iceServers = {
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
    ],
};

joinBtn.onclick = () => {
    const roomName = roomInput.value;
    if (!roomName) {
        alert("Lütfen bir oda adı girin.");
        return;
    }

    ws = new WebSocket("ws://SIGNALING_SERVER_IP:8765");

    ws.onopen = () => {
        console.log("SENDER: WebSocket bağlantısı açıldı.");
        ws.send(JSON.stringify({ type: 'join', room: roomName }));
        roomSelectionDiv.style.display = 'none';
        videoEl.style.display = 'block';
        init();
    };

    ws.onclose = () => console.error("SENDER: WebSocket bağlantısı kapandı!");
    ws.onerror = (err) => console.error("SENDER: WebSocket hatası:", err);

    ws.onmessage = async (msg) => {
        console.log("SENDER: Sunucudan mesaj alındı:", msg.data);
        const data = JSON.parse(msg.data);
        if(data.sdp){
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        }
        if(data.candidate){
            await pc.addIceCandidate(data.candidate);
        }
    };
};

async function init() {
    pc = new RTCPeerConnection(iceServers);
    pc.oniceconnectionstatechange = () => {
        iceStatusEl.textContent = pc.iceConnectionState;
        console.log(`SENDER: ICE durumu: ${pc.iceConnectionState}`);
    };

    try {
        const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        videoEl.srcObject = stream;
        stream.getTracks().forEach(t => pc.addTrack(t, stream));

        pc.onicecandidate = e => {
            if(e.candidate) {
                ws.send(JSON.stringify({candidate:e.candidate}));
            }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({sdp:pc.localDescription}));
    } catch (err) {
        console.error("SENDER: init() hatası:", err);
    }
}
</script>
</body>
</html>