<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Sender</title>
</head>
<body>
<h2>Gönderici WebRTC</h2>
<div id="room-selection">
    <input type="text" id="room-input" placeholder="Oda Adı Girin">
    <button id="join-btn">Odaya Katıl</button>
</div>
<video id="localVideo" autoplay muted playsinline style="display:none;"></video>
<p><b>ICE Durumu:</b> <span id="ice-status"></span></p>

<script>
const iceStatusEl = document.getElementById('ice-status');
const videoEl = document.getElementById("localVideo");
const roomInput = document.getElementById('room-input');
const joinBtn = document.getElementById('join-btn');
const roomSelectionDiv = document.getElementById('room-selection');

let pc;
let ws;
// HERKESE AÇIK GÜVENİLİR SİNYAL SUNUCUSU
const SIGNALING_SERVER_URL = "wss://simple-webrtc-p2p-signaling.glitch.me";

const iceServers = {
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
    ],
};

joinBtn.onclick = () => {
    const roomName = roomInput.value;
    if (!roomName) {
        alert("Lütfen bir oda adı girin.");
        return;
    }

    ws = new WebSocket(SIGNALING_SERVER_URL);

    ws.onopen = () => {
        console.log("SENDER: WebSocket bağlantısı açıldı.");
        // Sunucuya "ben bu odaya katıldım" mesajı gönderiyoruz.
        ws.send(JSON.stringify({ type: 'join', room: roomName }));
        roomSelectionDiv.style.display = 'none';
        videoEl.style.display = 'block';
        init();
    };

    ws.onclose = () => console.error("SENDER: WebSocket bağlantısı kapandı!");
    ws.onerror = (err) => console.error("SENDER: WebSocket hatası:", err);

    ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        // Gelen mesajların bizim odamız için olduğundan emin olalım (sunucu protokolü gereği)
        if (data.room === roomName) {
            if(data.sdp){
                await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            }
            if(data.candidate){
                await pc.addIceCandidate(data.candidate);
            }
        }
    };
};

// Mesajları gönderirken oda adını da ekliyoruz
function sendToServer(msg) {
    msg.room = roomInput.value;
    ws.send(JSON.stringify(msg));
}

async function init() {
    pc = new RTCPeerConnection(iceServers);
    pc.oniceconnectionstatechange = () => {
        iceStatusEl.textContent = pc.iceConnectionState;
    };

    const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    videoEl.srcObject = stream;
    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    pc.onicecandidate = e => {
        if(e.candidate) {
            sendToServer({candidate:e.candidate});
        }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendToServer({sdp:pc.localDescription});
}
</script>
</body>
</html>