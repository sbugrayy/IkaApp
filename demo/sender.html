<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF--8">
<title>Sender</title>
</head>
<body>
<h2>Gönderici WebRTC</h2>
<video id="localVideo" autoplay muted playsinline></video>
<p><b>ICE Durumu:</b> <span id="ice-status"></span></p>
<script>
console.log("SENDER: Script başladı.");
const iceStatusEl = document.getElementById('ice-status');
let pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
let ws = new WebSocket("ws://SIGNALING_SERVER_IP:8765"); // Bu satıra Python dokunacak
const videoEl = document.getElementById("localVideo");

ws.onopen = () => console.log("SENDER: Sinyal sunucusuna WebSocket bağlantısı açıldı.");
ws.onclose = () => console.error("SENDER: WebSocket bağlantısı kapandı!");
ws.onerror = (err) => console.error("SENDER: WebSocket hatası:", err);

// --- BAĞLANTI DURUMUNU İZLEME ---
pc.oniceconnectionstatechange = () => {
    console.log(`SENDER: ICE bağlantı durumu değişti: ${pc.iceConnectionState}`);
    iceStatusEl.textContent = pc.iceConnectionState;
    if (pc.iceConnectionState === 'failed') {
        console.error('SENDER: Peer connection başarısız oldu!');
    }
};

async function init() {
    try {
        console.log("SENDER: Kamera ve mikrofon isteniyor...");
        const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        videoEl.srcObject = stream;
        console.log("SENDER: Medya akışı alındı, PeerConnection'a ekleniyor.");
        stream.getTracks().forEach(t => pc.addTrack(t, stream));

        pc.onicecandidate = e => {
            if(e.candidate) {
                console.log("SENDER: Yeni ICE adayı bulundu, sunucuya gönderiliyor.");
                ws.send(JSON.stringify({candidate:e.candidate}));
            }
        };

        console.log("SENDER: 'Offer' (teklif) oluşturuluyor.");
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        if (ws.readyState === WebSocket.OPEN) {
            console.log("SENDER: Offer, sinyal sunucusuna gönderiliyor.");
            ws.send(JSON.stringify({sdp:pc.localDescription}));
        } else {
            // Eğer bağlantı henüz açık değilse, açılmasını bekle
            ws.onopen = () => {
                console.log("SENDER: WebSocket şimdi açıldı. Offer gönderiliyor.");
                ws.send(JSON.stringify({sdp:pc.localDescription}));
            };
        }
    } catch (err) {
        console.error("SENDER: init() fonksiyonunda hata:", err);
    }
}

ws.onmessage = async (msg) => {
    console.log("SENDER: Sinyal sunucusundan mesaj alındı:", msg.data);
    const data = JSON.parse(msg.data);
    if(data.sdp){
        console.log("SENDER: 'Answer' (cevap) alındı, remote description olarak ayarlanıyor.");
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    }
    if(data.candidate){
        console.log("SENDER: Alıcıdan gelen ICE adayı ekleniyor.");
        await pc.addIceCandidate(data.candidate);
    }
}

init();
</script>
</body>
</html>