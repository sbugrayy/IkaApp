<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>WebRTC Kayıt (Blob → Download)</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    video { width: 640px; max-width: 100%; background: #000; border-radius: 8px; }
    .row { margin-top: 12px; display: flex; gap: 8px; }
    button { padding: 8px 12px; border-radius: 8px; border: 0; cursor: pointer; }
  </style>
</head>
<body>
  <h2>WebRTC Kayıt (PyQt5 QWebEngineView)</h2>
  <video id="video" autoplay playsinline muted></video>
  <div class="row">
    <button id="startBtn">Kaydı Başlat</button>
    <button id="stopBtn" disabled>Kaydı Durdur</button>
  </div>
  <p id="status"></p>

  <script>
    let mediaRecorder;
    let chunks = [];
    let stream;

    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const videoEl  = document.getElementById('video');

    async function init() {
      try {
        // Kamera + mikrofon izni
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        videoEl.srcObject = stream;

        // Tarayıcı hangi mimeType'ı destekliyor, kontrol edelim
        const preferred = [
          'video/webm;codecs=vp9,opus',
          'video/webm;codecs=vp8,opus',
          'video/webm'
        ];
        let mimeType = '';
        for (const t of preferred) {
          if (MediaRecorder.isTypeSupported(t)) { mimeType = t; break; }
        }

        mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstart = () => {
          chunks = [];
          statusEl.textContent = 'Kayıt başladı...';
          startBtn.disabled = true;
          stopBtn.disabled = false;
        };

        mediaRecorder.onstop = async () => {
          statusEl.textContent = 'Kayıt durdu, dosya hazırlanıyor...';
          const blob = new Blob(chunks, { type: mediaRecorder.mimeType || 'video/webm' });

          // Blob'u object URL'e çevir
          const url = URL.createObjectURL(blob);

          // İndirme tetiklemesi (PyQt bu indirimi yakalayacak)
          const a = document.createElement('a');
          a.href = url;
          // Dosya adı burada set edilir; PyQt tarafında da path belirleyeceğiz
          a.download = 'webrtc_recording.webm';
          document.body.appendChild(a);
          a.click();
          a.remove();

          // Temizlik
          setTimeout(() => URL.revokeObjectURL(url), 10_000);
          statusEl.textContent = 'Dosya indiriliyor/kaydediliyor...';
          startBtn.disabled = false;
          stopBtn.disabled = true;
        };

        startBtn.onclick = () => mediaRecorder.start(1000); // 1sn parçalarla buffer
        stopBtn.onclick  = () => mediaRecorder.stop();

        statusEl.textContent = 'Hazır. Kayıt için "Kaydı Başlat" butonuna tıklayın.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Hata: ' + err.message;
      }
    }

    init();
  </script>
</body>
</html>
