<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>WebRTC Remote Stream Kayıt</title>
<style>
body { font-family: sans-serif; padding: 16px; }
video { width: 320px; max-width: 100%; background: #000; border-radius: 8px; margin: 8px; }
button { padding: 8px 12px; border-radius: 8px; border: 0; cursor: pointer; margin-top: 12px; }
#videos { display: flex; gap: 16px; flex-wrap: wrap; }
</style>
</head>
<body>
git 
<h2>WebRTC Remote Stream Kayıt</h2>
<div id="videos">
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
</div>
<br>
<button id="recordBtn">Kaydı Başlat/Durdur</button>
<p id="status"></p>

<script>
const peer_id = Math.random().toString(36).substring(2,10);
let pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

let mediaRecorder;
let chunks = [];
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const statusEl = document.getElementById("status");
const btn = document.getElementById("recordBtn");

navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
    localVideo.srcObject = stream;
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
});

pc.ontrack = event => {
    remoteVideo.srcObject = event.streams[0];
    statusEl.textContent = "Remote stream geldi.";
};


pc.onicecandidate = event => {
    if(event.candidate){
        fetch("/offer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ peer_id: peer_id, candidate: event.candidate })
        });
    }
};


async function negotiate() {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const response = await fetch("/offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            peer_id: peer_id,
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type
        })
    });

    const answer = await response.json();
    await pc.setRemoteDescription(answer);
}
negotiate();


btn.onclick = () => {
    if(!remoteVideo.srcObject){
        alert("Remote stream yok, kayıt başlatılamaz!");
        return;
    }

    if(!mediaRecorder || mediaRecorder.state === "inactive"){
        chunks = [];
        mediaRecorder = new MediaRecorder(remoteVideo.srcObject);
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
        mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: "video/webm" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "remote_stream.webm";
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            statusEl.textContent = "Kayıt tamamlandı.";
        };
        mediaRecorder.start(1000); 
        statusEl.textContent = "Kayıt başladı...";
        btn.textContent = "Kaydı Durdur";
    } else {
        mediaRecorder.stop();
        btn.textContent = "Kaydı Başlat/Durdur";
    }
};


</script>

</body>
</html>

